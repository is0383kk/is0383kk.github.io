---
title: "分離レベルとそれに伴い発生する弊害について"
date: 2023-11-20T20:07:27+09:00
draft: false
isCJKLanguage: true
tags: ["技術系","データベース"]
description : "この記事では、データベースの分離レベルについて詳しく解説します。トランザクションの分離レベルやそれが引き起こす一貫性、並行性、パフォーマンスへの影響に焦点を当て、データベース設計や運用上の問題点を探求します。"
keywords: [データベース,分離レベル,トランザクション,一貫性,並行性,パフォーマンス,データベース設計,データベース運用,ACID特性,READ UNCOMMITTED,READ COMMITTED,REPEATABLE READ,SERIALIZABLE]
---

---

## はじめに
今回は分離レベルとそれに伴い発生する弊害のお話です。

本記事のゴール設定は以下の通りです。
- **分離レベルは4種類**あることを理解する。
- 分離レベルに伴い発生する**3種類の弊害**について理解する
- 実運用する上で分離レベルは「**READ COMMITTED**」以上が望ましいことを理解する。

## ■ ACID特性とトランザクションの分離レベルの関係性
分離レベルの話の前に、トランザクション処理における4つの特性について押さえておきましょう。

### ACID特性
ACID特性とはトランザクション処理に保持すべき４つの特性のことです。
|特性|要約|
| --- | --- |
|{{< rawhtml >}} 原子性 <br>Atomicity {{< /rawhtml >}}|口座Aから口座Bに対し1万円送金する場合、口座Aと口座Bへの操作はすべて実行される(または、されない) COMMIT or ROLLBACK|
|{{< rawhtml >}}一貫性 <br> Consistency {{< /rawhtml >}}|口座Aから口座Bに対し1万円送金する場合、口座A、口座Bが負数になるような操作はできない　|
|{{< rawhtml >}} 独立性 <br> Isolation {{< /rawhtml >}}|トランザクションは同時に実行しても、単独で実行しても同じ結果でなければならない|
|{{< rawhtml >}} 
永続性 <br> Durability
{{< /rawhtml >}}|トランザクションが完了したら、<br> 障害が発生してもその操作結果は失われない|

今回お話しする「**トランザクションの分離レベル**」とは、
{{< rawhtml >}} 
<font size="5"><b>独立性（Isolation）</b></font>
{{< /rawhtml >}}
に関する概念のことです。

## ■ トランザクションの分離レベル
### 分離レベル
分離レベルには以下のものがあります。
| レベル | 説明 |
| --- | --- |
| 分離レベル0 | READ UNCOMMITTED - 未コミットレコードを他のトランザクションから参照できる |
| 分離レベル1 | READ COMMITTED - コミット済みレコードを他のトランザクションから参照できる |
| 分離レベル2 | REPEATABLE READ - トランザクション中は他のトランザクションでコミットされた更新を参照しない |
| 分離レベル3 | SERIALIZABLE - トランザクションを順序付けて処理する |

データの一貫性が非常に重要な場合や、同時アクセスが多い状況ほど分離レベルは高いことが推奨されます。

## ■ 分離レベルによって生じる弊害

また、分離レベルによって以下の弊害が生じます。  

### ★ ダーティリード：他のトランザクションで更新された、未コミットデータを読み込んでしまうこと 
1. ユーザBがテーブルの値を更新 → 1から2に更新 ※未コミット
2. **ユーザAがテーブルの値を参照 → 2を取得（ダーティリード）**
3. ユーザBがテーブルの値をコミットする
{{< figure src="../images/dread.png" alt="ダーティリード" width="600" >}}

### ★ ファジーリード：同じデータを2回読みとったとき、異なる内容となること
1. ユーザAがテーブルの値を取得 → 1を取得
2. ユーザBがテーブルの値を更新＆コミット → 1から2に更新
3. **ユーザAがテーブルの値を取得 → 2を取得（ファジーリード）**
{{< figure src="../images/fread.png" alt="ファジーリード" width="600" >}}

### ★ ファントムリード：2回データを読み取ったとき、新しい内容が追加されてしまうこと
1. ユーザAがテーブルの行を取得 → 行1を取得
2. ユーザBがテーブルに行2を挿入＆コミット → 行2が増える
3. **ユーザAが行を取得 → 行1と行2を取得（ファントムーリード）**

{{< figure src="../images/pread.png" alt="ファントムリード" width="600" >}}

--- 

分離レベルと弊害の関係性をまとめるとこのようになります。※○は発生する
| 分離レベル | ダーティリード | ファジーリード | ファントムリード |
| --- | --- | --- | --- |
| READ UNCOMMITTED | ○ | ○ | ○ |
| READ COMMITTED | × | ○ | ○ |
| REPEATABLE READ | × | × | ○ |
| SERIALIZABLE | × | × | × |

以上より、READ UNCOMMITTEDではダーティリード/ファジーリード/ファントムリードの全てが発生する可能性があり、  
一般的に実運用する上では、
{{< rawhtml >}} 
<font size="5"><b>READ COMMITTED以上が望ましいと言えます。</b></font>
{{< /rawhtml >}}

## 開発上での注意
分離レベルは使用するDB種別によってデフォルトの分離レベルが設定されています。  
以下は主なDBに設定されているデフォルト分離レベルです。（2023-11-27時点）

| データベース名 | バージョン | デフォルト分離レベル |
| --- | --- | --- |
| MySQL | 8.0 | REPEATABLE READ |
| Oracle Database | 19c | READ COMMITTED |
| Microsoft SQL Server | 2022 | READ COMMITTED |
| Amazon Aurora MySQL | 3 | REPEATABLE READ |

ここで注意することは、設計上想定している
{{< rawhtml >}} 
<font size="5"><b>アプリケーション側の分離レベルと使用するDBで設定されている分離レベルを一致させることです。</b></font>
{{< /rawhtml >}}

アプリケーション側とDB側で分離レベルが異なる場合は、DB側の分離レベルの変更を忘れないように注意する必要があります。